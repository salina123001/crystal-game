<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>水晶冒险</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#8b5cf6',
                        accent: '#ec4899',
                        light: '#a5b4fc',
                        dark: '#4f46e5',
                        danger: '#ef4444',
                        success: '#22c55e',
                        warning: '#f59e0b',
                        crystalBlue: '#3b82f6',
                        crystalPurple: '#8b5cf6',
                        crystalPink: '#ec4899',
                        crystalYellow: '#f59e0b'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            .text-shadow-lg {
                text-shadow: 0 4px 8px rgba(0, 0, 0, 0.12), 0 2px 4px rgba(0, 0, 0, 0.08);
            }
            .animate-float {
                animation: float 6s ease-in-out infinite;
            }
            .animate-pulse-slow {
                animation: pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }
            .animate-sparkle {
                animation: sparkle 1.5s ease-in-out infinite;
            }
            .backdrop-blur {
                backdrop-filter: blur(8px);
            }
            .glass {
                background: rgba(255, 255, 255, 0.25);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.18);
            }
            .glass-dark {
                background: rgba(15, 23, 42, 0.7);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
            100% { transform: translateY(0px); }
        }

        @keyframes sparkle {
            0% { opacity: 0.8; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
            100% { opacity: 0.8; transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-900 via-purple-800 to-pink-700 min-h-screen overflow-hidden text-white font-sans">
    <!-- 粒子背景容器 -->
    <div id="particles-container" class="fixed inset-0 z-0"></div>

    <!-- 开始界面 -->
    <div id="start-screen" class="fixed inset-0 z-30 flex flex-col items-center justify-center p-4 transition-opacity duration-1000">
        <h1 class="text-[clamp(2.5rem,8vw,5rem)] font-bold mb-6 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 text-shadow-lg text-center animate-pulse-slow">
            水晶冒险
        </h1>
        
        <div class="glass rounded-2xl p-8 w-full max-w-md mb-8 shadow-xl">
            <div class="flex justify-center mb-6">
                <div class="relative w-24 h-24">
                    <div class="absolute inset-0 bg-crystalBlue/30 rounded-full animate-pulse-slow"></div>
                    <div class="absolute inset-2 bg-crystalPurple/30 rounded-full animate-pulse-slow" style="animation-delay: 0.5s;"></div>
                    <div class="absolute inset-4 bg-crystalPink/30 rounded-full animate-pulse-slow" style="animation-delay: 1s;"></div>
                    <div class="absolute inset-6 bg-crystalYellow/30 rounded-full animate-sparkle"></div>
                </div>
            </div>
            
            <button id="start-button" class="w-full py-4 px-6 bg-gradient-to-r from-primary to-secondary rounded-full text-white font-bold text-lg shadow-lg hover:shadow-primary/50 transition-all duration-300 transform hover:-translate-y-1 focus:outline-none focus:ring-2 focus:ring-primary/50">
                <i class="fa fa-play mr-2"></i>开始游戏
            </button>
            
            <button id="how-to-play-button" class="w-full py-3 mt-4 text-white/80 hover:text-white transition-colors duration-300 focus:outline-none">
                <i class="fa fa-question-circle mr-2"></i>游戏说明
            </button>
        </div>
        
        <div class="text-white/60 text-sm">
            <p>© 2025 水晶冒险工作室</p>
        </div>
    </div>

    <!-- 游戏说明界面 -->
    <div id="instructions-screen" class="fixed inset-0 z-40 flex items-center justify-center p-4 bg-black/50 opacity-0 pointer-events-none transition-opacity duration-500">
        <div class="glass-dark rounded-2xl p-6 w-full max-w-lg shadow-2xl transform transition-transform duration-500 scale-95">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">游戏说明</h2>
                <button id="close-instructions" class="text-white/70 hover:text-white transition-colors">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4 text-white/90">
                <p><strong>游戏目标：</strong>收集水晶获得分数，避开黑暗能量，保持生命值。</p>
                
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-crystalBlue flex items-center justify-center mr-3">
                            <i class="fa fa-diamond"></i>
                        </div>
                        <span>蓝色水晶：+10分</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-crystalPurple flex items-center justify-center mr-3">
                            <i class="fa fa-diamond"></i>
                        </div>
                        <span>紫色水晶：+15分</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-crystalPink flex items-center justify-center mr-3">
                            <i class="fa fa-diamond"></i>
                        </div>
                        <span>粉色水晶：+20分</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-crystalYellow flex items-center justify-center mr-3">
                            <i class="fa fa-star"></i>
                        </div>
                        <span>黄色星光：恢复生命</span>
                    </div>
                    <div class="flex items-center col-span-2">
                        <div class="w-10 h-10 rounded-full bg-danger flex items-center justify-center mr-3">
                            <i class="fa fa-bolt"></i>
                        </div>
                        <span>黑暗能量：减少生命</span>
                    </div>
                </div>
                
                <p><strong>控制方式：</strong></p>
                <div class="grid grid-cols-2 gap-4">
                    <div class="flex items-center">
                        <div class="w-12 h-8 bg-white/10 rounded-md flex items-center justify-center mr-3">
                            <i class="fa fa-arrow-up"></i>
                        </div>
                        <span>向上移动</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-12 h-8 bg-white/10 rounded-md flex items-center justify-center mr-3">
                            <i class="fa fa-arrow-down"></i>
                        </div>
                        <span>向下移动</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-12 h-8 bg-white/10 rounded-md flex items-center justify-center mr-3">
                            <i class="fa fa-arrow-left"></i>
                        </div>
                        <span>向左移动</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-12 h-8 bg-white/10 rounded-md flex items-center justify-center mr-3">
                            <i class="fa fa-arrow-right"></i>
                        </div>
                        <span>向右移动</span>
                    </div>
                    <div class="flex items-center col-span-2">
                        <div class="w-12 h-8 bg-white/10 rounded-md flex items-center justify-center mr-3">
                            <i class="fa fa-pause"></i>
                        </div>
                        <span>暂停游戏</span>
                    </div>
                </div>
                
                <p><strong>提示：</strong>游戏难度会随时间增加，小心不要让生命值降为零！</p>
            </div>
            
            <button id="start-from-instructions" class="w-full mt-6 py-3 bg-gradient-to-r from-primary to-secondary rounded-lg text-white font-semibold shadow-lg hover:shadow-primary/50 transition-all duration-300">
                开始游戏
            </button>
        </div>
    </div>

    <!-- 游戏界面 -->
    <div id="game-screen" class="fixed inset-0 z-20 flex flex-col items-center justify-between p-4 opacity-0 pointer-events-none transition-opacity duration-1000">
        <!-- 游戏顶部信息 -->
        <div class="w-full flex justify-between items-center mb-4 z-10">
            <div class="glass rounded-xl p-3 flex items-center shadow-lg">
                <div class="flex items-center mr-6">
                    <i class="fa fa-trophy text-yellow-400 mr-2"></i>
                    <div>
                        <div class="text-xs text-white/70">分数</div>
                        <div id="score-display" class="text-xl font-bold">0</div>
                    </div>
                </div>
                <div class="flex items-center">
                    <i class="fa fa-heart text-danger mr-2"></i>
                    <div>
                        <div class="text-xs text-white/70">生命值</div>
                        <div class="flex items-center">
                            <div id="health-bar" class="h-2 w-32 bg-white/20 rounded-full overflow-hidden">
                                <div id="health-level" class="h-full bg-gradient-to-r from-green-400 to-green-600 rounded-full" style="width: 100%"></div>
                            </div>
                            <span id="health-value" class="ml-2 text-lg font-bold">100</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <button id="pause-button" class="glass rounded-full p-3 shadow-lg hover:bg-white/30 transition-colors">
                <i class="fa fa-pause"></i>
            </button>
        </div>
        
        <!-- 游戏画布容器 -->
        <div class="relative w-full max-w-4xl flex-grow">
            <canvas id="game-canvas" class="w-full h-full rounded-2xl shadow-2xl"></canvas>
            
            <!-- 移动设备控制按钮 -->
            <div id="mobile-controls" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 grid grid-cols-3 gap-4 w-64 md:hidden z-10">
                <div></div>
                <button id="btn-up" class="glass rounded-full p-4 flex items-center justify-center shadow-lg">
                    <i class="fa fa-arrow-up text-xl"></i>
                </button>
                <div></div>
                <button id="btn-left" class="glass rounded-full p-4 flex items-center justify-center shadow-lg">
                    <i class="fa fa-arrow-left text-xl"></i>
                </button>
                <div></div>
                <button id="btn-right" class="glass rounded-full p-4 flex items-center justify-center shadow-lg">
                    <i class="fa fa-arrow-right text-xl"></i>
                </button>
                <div></div>
                <button id="btn-down" class="glass rounded-full p-4 flex items-center justify-center shadow-lg">
                    <i class="fa fa-arrow-down text-xl"></i>
                </button>
                <div></div>
            </div>
        </div>
    </div>

    <!-- 暂停菜单 -->
    <div id="pause-menu" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 opacity-0 pointer-events-none transition-opacity duration-500">
        <div class="glass-dark rounded-2xl p-8 w-full max-w-md shadow-2xl transform transition-transform duration-500 scale-95">
            <h2 class="text-3xl font-bold text-center mb-6">游戏暂停</h2>
            
            <div class="space-y-4">
                <button id="resume-button" class="w-full py-4 px-6 bg-gradient-to-r from-primary to-secondary rounded-lg text-white font-bold text-lg shadow-lg hover:shadow-primary/50 transition-all duration-300 transform hover:-translate-y-1">
                    <i class="fa fa-play mr-2"></i>继续游戏
                </button>
                
                <button id="restart-button" class="w-full py-4 px-6 bg-gradient-to-r from-warning to-orange-500 rounded-lg text-white font-bold text-lg shadow-lg hover:shadow-warning/50 transition-all duration-300 transform hover:-translate-y-1">
                    <i class="fa fa-refresh mr-2"></i>重新开始
                </button>
                
                <button id="quit-button" class="w-full py-4 px-6 bg-gradient-to-r from-gray-700 to-gray-600 rounded-lg text-white font-bold text-lg shadow-lg hover:shadow-gray-500/50 transition-all duration-300 transform hover:-translate-y-1">
                    <i class="fa fa-sign-out mr-2"></i>退出游戏
                </button>
            </div>
        </div>
    </div>

    <!-- 游戏结束界面 -->
    <div id="game-over-screen" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 opacity-0 pointer-events-none transition-opacity duration-1000">
        <div class="glass-dark rounded-2xl p-8 w-full max-w-md shadow-2xl transform transition-transform duration-1000 scale-95">
            <div class="text-center mb-6">
                <h2 class="text-4xl font-bold text-danger mb-2">游戏结束</h2>
                <div class="text-xl text-white/80">你的冒险结束了</div>
            </div>
            
            <div class="space-y-6">
                <div class="glass rounded-xl p-4 text-center">
                    <div class="text-white/70 mb-1">最终得分</div>
                    <div id="final-score" class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500">0</div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="glass rounded-xl p-4 text-center">
                        <div class="text-white/70 text-sm mb-1">最高得分</div>
                        <div id="high-score" class="text-2xl font-bold">0</div>
                    </div>
                    <div class="glass rounded-xl p-4 text-center">
                        <div class="text-white/70 text-sm mb-1">游戏时长</div>
                        <div id="game-duration" class="text-2xl font-bold">00:00</div>
                    </div>
                </div>
                
                <button id="play-again-button" class="w-full py-4 px-6 bg-gradient-to-r from-primary to-secondary rounded-lg text-white font-bold text-lg shadow-lg hover:shadow-primary/50 transition-all duration-300 transform hover:-translate-y-1">
                    <i class="fa fa-refresh mr-2"></i>再玩一次
                </button>
                
                <button id="back-to-menu-button" class="w-full py-4 px-6 bg-gradient-to-r from-gray-700 to-gray-600 rounded-lg text-white font-bold text-lg shadow-lg hover:shadow-gray-500/50 transition-all duration-300 transform hover:-translate-y-1">
                    <i class="fa fa-home mr-2"></i>返回主菜单
                </button>
            </div>
        </div>
    </div>

    <script>
        // 游戏状态
        const gameState = {
            isRunning: false,
            isPaused: false,
            score: 0,
            health: 100,
            highScore: localStorage.getItem('crystalAdventureHighScore') || 0,
            startTime: 0,
            lastTime: 0,
            gameTime: 0,
            difficulty: 1,
            player: {
                x: 0,
                y: 0,
                width: 40,
                height: 40,
                speed: 5,
                dx: 0,
                dy: 0
            },
            crystals: [],
            darkEnergies: [],
            starLights: [],
            particleEffects: []
        };

        // DOM元素
        const startScreen = document.getElementById('start-screen');
        const instructionsScreen = document.getElementById('instructions-screen');
        const gameScreen = document.getElementById('game-screen');
        const pauseMenu = document.getElementById('pause-menu');
        const gameOverScreen = document.getElementById('game-over-screen');
        const startButton = document.getElementById('start-button');
        const howToPlayButton = document.getElementById('how-to-play-button');
        const closeInstructionsButton = document.getElementById('close-instructions');
        const startFromInstructionsButton = document.getElementById('start-from-instructions');
        const pauseButton = document.getElementById('pause-button');
        const resumeButton = document.getElementById('resume-button');
        const restartButton = document.getElementById('restart-button');
        const quitButton = document.getElementById('quit-button');
        const playAgainButton = document.getElementById('play-again-button');
        const backToMenuButton = document.getElementById('back-to-menu-button');
        const scoreDisplay = document.getElementById('score-display');
        const healthBar = document.getElementById('health-bar');
        const healthLevel = document.getElementById('health-level');
        const healthValue = document.getElementById('health-value');
        const finalScoreDisplay = document.getElementById('final-score');
        const highScoreDisplay = document.getElementById('high-score');
        const gameDurationDisplay = document.getElementById('game-duration');
        const gameCanvas = document.getElementById('game-canvas');
        const ctx = gameCanvas.getContext('2d');
        
        // 移动控制按钮
        const btnUp = document.getElementById('btn-up');
        const btnDown = document.getElementById('btn-down');
        const btnLeft = document.getElementById('btn-left');
        const btnRight = document.getElementById('btn-right');

        // 设置Canvas尺寸
        function resizeCanvas() {
            const container = gameCanvas.parentElement;
            gameCanvas.width = container.clientWidth;
            gameCanvas.height = container.clientHeight;
        }

        // 创建粒子背景
        function createParticles() {
            const container = document.getElementById('particles-container');
            container.innerHTML = '';
            
            for (let i = 0; i < 100; i++) {
                const particle = document.createElement('div');
                
                // 随机大小和位置
                const size = Math.random() * 5 + 1;
                const x = Math.random() * 100;
                const y = Math.random() * 100;
                const duration = Math.random() * 30 + 20;
                const delay = Math.random() * 10;
                
                // 随机颜色
                const colors = [
                    'rgba(139, 92, 246, 0.5)', // purple
                    'rgba(59, 130, 246, 0.5)', // blue
                    'rgba(236, 72, 153, 0.5)', // pink
                    'rgba(245, 158, 11, 0.5)'  // yellow
                ];
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                particle.style.position = 'absolute';
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.borderRadius = '50%';
                particle.style.backgroundColor = color;
                particle.style.left = `${x}%`;
                particle.style.top = `${y}%`;
                particle.style.animation = `float ${duration}s ease-in-out ${delay}s infinite`;
                
                container.appendChild(particle);
            }
        }

        // 初始化游戏
        function initGame() {
            resizeCanvas();
            createParticles();
            
            // 设置玩家初始位置
            gameState.player.x = gameCanvas.width / 2 - gameState.player.width / 2;
            gameState.player.y = gameCanvas.height / 2 - gameState.player.height / 2;
            
            // 清空游戏元素
            gameState.crystals = [];
            gameState.darkEnergies = [];
            gameState.starLights = [];
            gameState.particleEffects = [];
            
            // 重置游戏状态
            gameState.score = 0;
            gameState.health = 100;
            gameState.difficulty = 1;
            gameState.gameTime = 0;
            
            // 更新UI
            updateScore();
            updateHealth();
            highScoreDisplay.textContent = gameState.highScore;
        }

        // 开始游戏
        function startGame() {
            initGame();
            
            // 隐藏开始界面，显示游戏界面
            startScreen.classList.add('opacity-0', 'pointer-events-none');
            instructionsScreen.classList.add('opacity-0', 'pointer-events-none');
            gameScreen.classList.remove('opacity-0', 'pointer-events-none');
            
            // 开始游戏循环
            gameState.isRunning = true;
            gameState.isPaused = false;
            gameState.startTime = performance.now();
            gameState.lastTime = gameState.startTime;
            
            requestAnimationFrame(gameLoop);
        }

        // 暂停游戏
        function pauseGame() {
            gameState.isPaused = true;
            pauseMenu.classList.remove('opacity-0', 'pointer-events-none');
            pauseMenu.querySelector('div').classList.remove('scale-95');
            pauseMenu.querySelector('div').classList.add('scale-100');
        }

        // 恢复游戏
        function resumeGame() {
            gameState.isPaused = false;
            pauseMenu.classList.add('opacity-0', 'pointer-events-none');
            pauseMenu.querySelector('div').classList.remove('scale-100');
            pauseMenu.querySelector('div').classList.add('scale-95');
            gameState.lastTime = performance.now();
            requestAnimationFrame(gameLoop);
        }

        // 游戏结束
        function gameOver() {
            gameState.isRunning = false;
            
            // 更新最高分
            if (gameState.score > gameState.highScore) {
                gameState.highScore = gameState.score;
                localStorage.setItem('crystalAdventureHighScore', gameState.highScore);
            }
            
            // 计算游戏时长
            const minutes = Math.floor(gameState.gameTime / 60);
            const seconds = Math.floor(gameState.gameTime % 60);
            const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // 更新结束界面
            finalScoreDisplay.textContent = gameState.score;
            highScoreDisplay.textContent = gameState.highScore;
            gameDurationDisplay.textContent = formattedTime;
            
            // 显示游戏结束界面
            gameOverScreen.classList.remove('opacity-0', 'pointer-events-none');
            gameOverScreen.querySelector('div').classList.remove('scale-95');
            gameOverScreen.querySelector('div').classList.add('scale-100');
        }

        // 更新分数显示
        function updateScore() {
            scoreDisplay.textContent = gameState.score;
        }

        // 更新生命值显示
        function updateHealth() {
            healthValue.textContent = gameState.health;
            healthLevel.style.width = `${gameState.health}%`;
            
            // 根据生命值改变颜色
            if (gameState.health > 70) {
                healthLevel.className = 'h-full bg-gradient-to-r from-green-400 to-green-600 rounded-full';
            } else if (gameState.health > 30) {
                healthLevel.className = 'h-full bg-gradient-to-r from-yellow-400 to-yellow-600 rounded-full';
            } else {
                healthLevel.className = 'h-full bg-gradient-to-r from-red-400 to-red-600 rounded-full';
            }
        }

        // 生成水晶
        function spawnCrystal() {
            const crystalTypes = [
                { color: '#3b82f6', value: 10, size: 15 }, // blue
                { color: '#8b5cf6', value: 15, size: 18 }, // purple
                { color: '#ec4899', value: 20, size: 20 }, // pink
                { color: '#f59e0b', value: 25, size: 22 }  // yellow
            ];
            
            const type = crystalTypes[Math.floor(Math.random() * crystalTypes.length)];
            const x = Math.random() * (gameCanvas.width - type.size * 2);
            const y = -type.size * 2;
            const speed = 1 + Math.random() * gameState.difficulty;
            
            gameState.crystals.push({
                x,
                y,
                size: type.size,
                color: type.color,
                value: type.value,
                speed,
                collected: false,
                floatOffset: 0,
                floatDirection: 1
            });
        }

        // 生成黑暗能量
        function spawnDarkEnergy() {
            const x = Math.random() * (gameCanvas.width - 30);
            const y = -40;
            const speed = 1.5 + Math.random() * gameState.difficulty;
            
            gameState.darkEnergies.push({
                x,
                y,
                width: 30,
                height: 30,
                speed,
                rotation: 0,
                rotationSpeed: 0.05 + Math.random() * 0.05
            });
        }

        // 生成星光
        function spawnStarLight() {
            if (Math.random() > 0.01) return; // 低概率生成
            
            const x = Math.random() * (gameCanvas.width - 25);
            const y = -30;
            const speed = 1 + Math.random() * gameState.difficulty * 0.7;
            
            gameState.starLights.push({
                x,
                y,
                size: 25,
                speed,
                rotation: 0,
                rotationSpeed: 0.03 + Math.random() * 0.03,
                alpha: 0.8 + Math.random() * 0.2
            });
        }

        // 创建粒子效果
        function createParticleEffect(x, y, color, count = 10) {
            for (let i = 0; i < count; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 1 + Math.random() * 3;
                const size = 2 + Math.random() * 4;
                const duration = 60 + Math.random() * 60;
                
                gameState.particleEffects.push({
                    x,
                    y,
                    size,
                    color,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    life: 0,
                    maxLife: duration
                });
            }
        }

        // 检测碰撞
        function checkCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }

        // 更新游戏状态
        function update(deltaTime) {
            // 增加游戏时间
            gameState.gameTime += deltaTime / 1000;
            
            // 每10秒增加难度
            gameState.difficulty = 1 + gameState.gameTime / 60 * 0.5;
            
            // 更新玩家位置
            gameState.player.x += gameState.player.dx;
            gameState.player.y += gameState.player.dy;
            
            // 限制玩家在画布内
            if (gameState.player.x < 0) gameState.player.x = 0;
            if (gameState.player.x + gameState.player.width > gameCanvas.width) {
                gameState.player.x = gameCanvas.width - gameState.player.width;
            }
            if (gameState.player.y < 0) gameState.player.y = 0;
            if (gameState.player.y + gameState.player.height > gameCanvas.height) {
                gameState.player.y = gameCanvas.height - gameState.player.height;
            }
            
            // 生成水晶
            if (Math.random() < 0.02 * gameState.difficulty) {
                spawnCrystal();
            }
            
            // 生成黑暗能量
            if (Math.random() < 0.015 * gameState.difficulty) {
                spawnDarkEnergy();
            }
            
            // 生成星光
            spawnStarLight();
            
            // 更新水晶
            for (let i = gameState.crystals.length - 1; i >= 0; i--) {
                const crystal = gameState.crystals[i];
                
                // 移动水晶
                crystal.y += crystal.speed;
                
                // 水晶浮动效果
                crystal.floatOffset += 0.05;
                if (crystal.floatOffset > 5) crystal.floatDirection = -1;
                if (crystal.floatOffset < -5) crystal.floatDirection = 1;
                crystal.floatOffset += crystal.floatDirection * 0.1;
                
                // 移除超出画布的水晶
                if (crystal.y > gameCanvas.height) {
                    gameState.crystals.splice(i, 1);
                    continue;
                }
                
                // 检测与玩家的碰撞
                if (!crystal.collected && checkCollision({
                    x: crystal.x,
                    y: crystal.y + crystal.floatOffset,
                    width: crystal.size * 2,
                    height: crystal.size * 2
                }, gameState.player)) {
                    crystal.collected = true;
                    
                    // 增加分数
                    gameState.score += crystal.value;
                    updateScore();
                    
                    // 创建粒子效果
                    createParticleEffect(crystal.x + crystal.size, crystal.y + crystal.size, crystal.color);
                    
                    // 移除水晶
                    setTimeout(() => {
                        const index = gameState.crystals.findIndex(c => c === crystal);
                        if (index !== -1) gameState.crystals.splice(index, 1);
                    }, 100);
                }
            }
            
            // 更新黑暗能量
            for (let i = gameState.darkEnergies.length - 1; i >= 0; i--) {
                const darkEnergy = gameState.darkEnergies[i];
                
                // 移动黑暗能量
                darkEnergy.y += darkEnergy.speed;
                darkEnergy.rotation += darkEnergy.rotationSpeed;
                
                // 移除超出画布的黑暗能量
                if (darkEnergy.y > gameCanvas.height) {
                    gameState.darkEnergies.splice(i, 1);
                    continue;
                }
                
                // 检测与玩家的碰撞
                if (checkCollision(darkEnergy, gameState.player)) {
                    // 减少生命值
                    gameState.health -= 15;
                    updateHealth();
                    
                    // 创建粒子效果
                    createParticleEffect(darkEnergy.x + darkEnergy.width/2, darkEnergy.y + darkEnergy.height/2, '#1e293b');
                    
                    // 移除黑暗能量
                    gameState.darkEnergies.splice(i, 1);
                    
                    // 检查游戏是否结束
                    if (gameState.health <= 0) {
                        gameOver();
                        return;
                    }
                }
            }
            
            // 更新星光
            for (let i = gameState.starLights.length - 1; i >= 0; i--) {
                const starLight = gameState.starLights[i];
                
                // 移动星光
                starLight.y += starLight.speed;
                starLight.rotation += starLight.rotationSpeed;
                
                // 闪烁效果
                starLight.alpha = 0.7 + Math.sin(performance.now() * 0.002) * 0.3;
                
                // 移除超出画布的星光
                if (starLight.y > gameCanvas.height) {
                    gameState.starLights.splice(i, 1);
                    continue;
                }
                
                // 检测与玩家的碰撞
                if (checkCollision({
                    x: starLight.x,
                    y: starLight.y,
                    width: starLight.size,
                    height: starLight.size
                }, gameState.player)) {
                    // 恢复生命值
                    gameState.health = Math.min(gameState.health + 25, 100);
                    updateHealth();
                    
                    // 创建粒子效果
                    createParticleEffect(starLight.x + starLight.size/2, starLight.y + starLight.size/2, '#f59e0b', 15);
                    
                    // 移除星光
                    gameState.starLights.splice(i, 1);
                }
            }
            
            // 更新粒子效果
            for (let i = gameState.particleEffects.length - 1; i >= 0; i--) {
                const particle = gameState.particleEffects[i];
                
                // 更新粒子位置
                particle.x += particle.vx;
                particle.y += particle.vy;
                
                // 粒子衰减
                particle.life++;
                if (particle.life >= particle.maxLife) {
                    gameState.particleEffects.splice(i, 1);
                }
            }
        }

        // 渲染游戏
        function render() {
            // 清空画布
            ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
            
            // 绘制渐变背景
            const gradient = ctx.createLinearGradient(0, 0, 0, gameCanvas.height);
            gradient.addColorStop(0, 'rgba(99, 102, 241, 0.2)');
            gradient.addColorStop(1, 'rgba(139, 92, 246, 0.2)');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);
            
            // 绘制网格背景
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.lineWidth = 1;
            
            const gridSize = 40;
            for (let x = 0; x < gameCanvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, gameCanvas.height);
                ctx.stroke();
            }
            
            for (let y = 0; y < gameCanvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(gameCanvas.width, y);
                ctx.stroke();
            }
            
            // 绘制玩家
            ctx.save();
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.shadowColor = 'rgba(139, 92, 246, 0.8)';
            ctx.shadowBlur = 20;
            ctx.beginPath();
            ctx.arc(
                gameState.player.x + gameState.player.width / 2,
                gameState.player.y + gameState.player.height / 2,
                gameState.player.width / 2,
                0,
                Math.PI * 2
            );
            ctx.fill();
            
            // 玩家内部光晕
            const playerGradient = ctx.createRadialGradient(
                gameState.player.x + gameState.player.width / 2,
                gameState.player.y + gameState.player.height / 2,
                0,
                gameState.player.x + gameState.player.width / 2,
                gameState.player.y + gameState.player.height / 2,
                gameState.player.width / 2
            );
            playerGradient.addColorStop(0, 'rgba(255, 255, 255, 0.7)');
            playerGradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
            
            ctx.fillStyle = playerGradient;
            ctx.fill();
            ctx.restore();
            
            // 绘制水晶
            for (const crystal of gameState.crystals) {
                if (crystal.collected) continue;
                
                ctx.save();
                ctx.fillStyle = crystal.color;
                ctx.shadowColor = crystal.color;
                ctx.shadowBlur = 15;
                
                // 绘制水晶主体
                ctx.beginPath();
                ctx.moveTo(crystal.x + crystal.size, crystal.y + crystal.floatOffset);
                ctx.lineTo(crystal.x + crystal.size * 2, crystal.y + crystal.size + crystal.floatOffset);
                ctx.lineTo(crystal.x + crystal.size, crystal.y + crystal.size * 2 + crystal.floatOffset);
                ctx.lineTo(crystal.x, crystal.y + crystal.size + crystal.floatOffset);
                ctx.closePath();
                ctx.fill();
                
                // 水晶高光
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.beginPath();
                ctx.moveTo(crystal.x + crystal.size, crystal.y + crystal.floatOffset);
                ctx.lineTo(crystal.x + crystal.size * 1.5, crystal.y + crystal.size * 0.7 + crystal.floatOffset);
                ctx.lineTo(crystal.x + crystal.size, crystal.y + crystal.size * 1.4 + crystal.floatOffset);
                ctx.lineTo(crystal.x + crystal.size * 0.5, crystal.y + crystal.size * 0.7 + crystal.floatOffset);
                ctx.closePath();
                ctx.fill();
                
                ctx.restore();
            }
            
            // 绘制黑暗能量
            for (const darkEnergy of gameState.darkEnergies) {
                ctx.save();
                ctx.fillStyle = 'rgba(30, 41, 59, 0.9)';
                ctx.shadowColor = 'rgba(15, 23, 42, 0.8)';
                ctx.shadowBlur = 15;
                
                // 移动到中心
                ctx.translate(darkEnergy.x + darkEnergy.width / 2, darkEnergy.y + darkEnergy.height / 2);
                ctx.rotate(darkEnergy.rotation);
                
                // 绘制黑暗能量
                ctx.beginPath();
                ctx.moveTo(-darkEnergy.width / 2, 0);
                ctx.lineTo(0, -darkEnergy.height / 2);
                ctx.lineTo(darkEnergy.width / 2, 0);
                ctx.lineTo(0, darkEnergy.height / 2);
                ctx.closePath();
                ctx.fill();
                
                // 内部细节
                ctx.fillStyle = 'rgba(59, 130, 246, 0.2)';
                ctx.beginPath();
                ctx.moveTo(-darkEnergy.width / 4, 0);
                ctx.lineTo(0, -darkEnergy.height / 4);
                ctx.lineTo(darkEnergy.width / 4, 0);
                ctx.lineTo(0, darkEnergy.height / 4);
                ctx.closePath();
                ctx.fill();
                
                ctx.restore();
            }
            
            // 绘制星光
            for (const starLight of gameState.starLights) {
                ctx.save();
                ctx.fillStyle = `rgba(245, 158, 11, ${starLight.alpha})`;
                ctx.shadowColor = 'rgba(245, 158, 11, 0.8)';
                ctx.shadowBlur = 20;
                
                // 移动到中心
                ctx.translate(starLight.x + starLight.size / 2, starLight.y + starLight.size / 2);
                ctx.rotate(starLight.rotation);
                
                // 绘制星光
                const size = starLight.size / 2;
                ctx.beginPath();
                for (let i = 0; i < 5; i++) {
                    const angle = i * 2 * Math.PI / 5 - Math.PI / 2;
                    const nextAngle = (i + 1) * 2 * Math.PI / 5 - Math.PI / 2;
                    
                    ctx.lineTo(Math.cos(angle) * size, Math.sin(angle) * size);
                    ctx.lineTo(Math.cos(nextAngle) * size * 0.5, Math.sin(nextAngle) * size * 0.5);
                }
                ctx.closePath();
                ctx.fill();
                
                ctx.restore();
            }
            
            // 绘制粒子效果
            for (const particle of gameState.particleEffects) {
                const alpha = 1 - particle.life / particle.maxLife;
                ctx.save();
                ctx.fillStyle = `${particle.color}${Math.floor(alpha * 255).toString(16).padStart(2, '0')}`;
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
            
            // 绘制游戏难度指示器
            ctx.save();
            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
            ctx.font = '12px Inter, sans-serif';
            ctx.textAlign = 'right';
            ctx.fillText(`难度: ${Math.round(gameState.difficulty * 10) / 10}x`, gameCanvas.width - 10, 20);
            ctx.restore();
        }

        // 游戏主循环
        function gameLoop(timestamp) {
            if (!gameState.isRunning || gameState.isPaused) return;
            
            // 计算时间差
            const deltaTime = timestamp - gameState.lastTime;
            gameState.lastTime = timestamp;
            
            // 更新游戏状态
            update(deltaTime);
            
            // 渲染游戏
            render();
            
            // 继续游戏循环
            requestAnimationFrame(gameLoop);
        }

        // 键盘控制
        function handleKeyDown(e) {
            if (!gameState.isRunning || gameState.isPaused) return;
            
            switch (e.key) {
                case 'ArrowUp':
                case 'w':
                case 'W':
                    gameState.player.dy = -gameState.player.speed;
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                    gameState.player.dy = gameState.player.speed;
                    break;
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    gameState.player.dx = -gameState.player.speed;
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    gameState.player.dx = gameState.player.speed;
                    break;
                case ' ':
                case 'Escape':
                    pauseGame();
                    break;
            }
        }

        function handleKeyUp(e) {
            switch (e.key) {
                case 'ArrowUp':
                case 'w':
                case 'W':
                    if (gameState.player.dy < 0) gameState.player.dy = 0;
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                    if (gameState.player.dy > 0) gameState.player.dy = 0;
                    break;
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    if (gameState.player.dx < 0) gameState.player.dx = 0;
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    if (gameState.player.dx > 0) gameState.player.dx = 0;
                    break;
            }
        }

        // 移动设备触控控制
        function setupMobileControls() {
            btnUp.addEventListener('touchstart', () => { gameState.player.dy = -gameState.player.speed; });
            btnUp.addEventListener('touchend', () => { if (gameState.player.dy < 0) gameState.player.dy = 0; });
            
            btnDown.addEventListener('touchstart', () => { gameState.player.dy = gameState.player.speed; });
            btnDown.addEventListener('touchend', () => { if (gameState.player.dy > 0) gameState.player.dy = 0; });
            
            btnLeft.addEventListener('touchstart', () => { gameState.player.dx = -gameState.player.speed; });
            btnLeft.addEventListener('touchend', () => { if (gameState.player.dx < 0) gameState.player.dx = 0; });
            
            btnRight.addEventListener('touchstart', () => { gameState.player.dx = gameState.player.speed; });
            btnRight.addEventListener('touchend', () => { if (gameState.player.dx > 0) gameState.player.dx = 0; });
        }

        // 初始化事件监听
        function initEventListeners() {
            // 开始界面按钮
            startButton.addEventListener('click', startGame);
            howToPlayButton.addEventListener('click', () => {
                startScreen.classList.add('opacity-0', 'pointer-events-none');
                instructionsScreen.classList.remove('opacity-0', 'pointer-events-none');
                instructionsScreen.querySelector('div').classList.remove('scale-95');
                instructionsScreen.querySelector('div').classList.add('scale-100');
            });
            
            // 游戏说明界面按钮
            closeInstructionsButton.addEventListener('click', () => {
                instructionsScreen.classList.add('opacity-0', 'pointer-events-none');
                instructionsScreen.querySelector('div').classList.remove('scale-100');
                instructionsScreen.querySelector('div').classList.add('scale-95');
                startScreen.classList.remove('opacity-0', 'pointer-events-none');
            });
            
            startFromInstructionsButton.addEventListener('click', startGame);
            
            // 游戏界面按钮
            pauseButton.addEventListener('click', pauseGame);
            
            // 暂停菜单按钮
            resumeButton.addEventListener('click', resumeGame);
            restartButton.addEventListener('click', () => {
                pauseMenu.classList.add('opacity-0', 'pointer-events-none');
                pauseMenu.querySelector('div').classList.remove('scale-100');
                pauseMenu.querySelector('div').classList.add('scale-95');
                startGame();
            });
            quitButton.addEventListener('click', () => {
                pauseMenu.classList.add('opacity-0', 'pointer-events-none');
                pauseMenu.querySelector('div').classList.remove('scale-100');
                pauseMenu.querySelector('div').classList.add('scale-95');
                gameState.isRunning = false;
                gameScreen.classList.add('opacity-0', 'pointer-events-none');
                startScreen.classList.remove('opacity-0', 'pointer-events-none');
            });
            
            // 游戏结束界面按钮
            playAgainButton.addEventListener('click', () => {
                gameOverScreen.classList.add('opacity-0', 'pointer-events-none');
                gameOverScreen.querySelector('div').classList.remove('scale-100');
                gameOverScreen.querySelector('div').classList.add('scale-95');
                startGame();
            });
            
            backToMenuButton.addEventListener('click', () => {
                gameOverScreen.classList.add('opacity-0', 'pointer-events-none');
                gameOverScreen.querySelector('div').classList.remove('scale-100');
                gameOverScreen.querySelector('div').classList.add('scale-95');
                gameState.isRunning = false;
                gameScreen.classList.add('opacity-0', 'pointer-events-none');
                startScreen.classList.remove('opacity-0', 'pointer-events-none');
            });
            
            // 键盘控制
            window.addEventListener('keydown', handleKeyDown);
            window.addEventListener('keyup', handleKeyUp);
            
            // 窗口大小变化
            window.addEventListener('resize', () => {
                if (gameState.isRunning) {
                    resizeCanvas();
                }
            });
            
            // 移动设备控制
            setupMobileControls();
        }

        // 初始化游戏
        initEventListeners();
        initGame();
    </script>
</body>
</html>
    